---
- name: Install Postgres prerequisites
  apt:
    name: ["libpq-dev", "python-psycopg2", "python3-psycopg2"]
    state: latest

- name: Postgres database directories
  file:
    path: "{{ item }}"
    state: directory
    # mode: 0755
  with_items:
    - "{{ postgres_data_directory }}/pgdata"

- name: Create Docker Postgres network
  docker_network:
    name: postgres

- name: Postgres Docker Container
  docker_container:
    name: postgres
    image: "{{ postgres_docker_image }}"
    pull: true
    purge_networks: true
    networks:
      - name: postgres
    env:
      POSTGRES_USER: "{{ postgres_user }}"
      POSTGRES_PASSWORD: "{{ postgres_password }}"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "{{ postgres_data_directory }}/pgdata:/var/lib/postgresql/data:rw"
    ports:
      - 5432:5432
    restart_policy: unless-stopped
    memory: 1g
    labels:
      com.centurylinklabs.watchtower.enable: "false"

- name: "Wait for Postgres server is up"
  wait_for:
    port: 5432
    timeout: 60
